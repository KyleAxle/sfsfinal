<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Portal Login</title>
  <link rel="stylesheet" href="Email_Login_CSS.css" />
  <!-- Supabase configuration -->
  <meta name="supabase-url" content="https://qqxznbyyttjetltturgf.supabase.co">
  <meta name="supabase-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxeHpuYnl5dHRqZXRsdHR1cmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzYwMzcsImV4cCI6MjA3ODM1MjAzN30.YSntqIoI9Fgi-Nqr2_iE2EYPOE_Yyie73rQ1oRs5g1o">
  <!-- Supabase JS (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <!-- Navigation (Hamburger + Sidebar) -->
  <nav class="navbar">
    <div class="menu-icon" id="menuIcon">&#9776;</div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="close-btn" id="closeBtn">&times;</div>
    <h2>Menu</h2>
    <a href="#">OLSIS</a>
    <a href="#">CJC Main Page</a>
  </div>

  <!-- Overlay (background when sidebar opens) -->
  <div class="overlay" id="overlay"></div>

  <!-- Main Login Section -->
  <div class="container">
    <div class="logo">
      <img src="C:\\Users\\cuber\\OneDrive\\Desktop\\Capstone 2025\\Picture\\cjclogo.png" alt="School Logo">
    </div>

    <form id="loginForm" class="login-form">
      <div id="loginError" style="color:#b00020;margin-bottom:8px;display:none"></div>
      <div class="input-group">
        <input id="loginEmail" name="email" type="email" placeholder="Email" required />
      </div>
      <div class="input-group">
        <input id="loginPassword" name="password" type="password" placeholder="Password" required />
      </div>

      <button type="submit" class="btn">Get Started</button>

      <div class="links">
        <a href="Create_Account.html">Create Account</a>
        <a href="#" id="resendLink">Resend confirmation email</a>
      </div>
    </form>
  </div>

  <!-- Login handler (tries Supabase if keys are provided, falls back to localStorage) -->
    <script>
      // Initialize supabase client if keys available in meta tags on this page or in the signup page
      const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || '';
      const SUPABASE_KEY = document.querySelector('meta[name="supabase-key"]')?.content || '';
      let supabaseClient = null;
      try {
        if (SUPABASE_URL && SUPABASE_KEY && window.supabase && typeof window.supabase.createClient === 'function') {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
      } catch (err) {
        console.warn('Supabase init failed on login page:', err);
        supabaseClient = null;
      }

      const loginForm = document.getElementById('loginForm');
      const loginError = document.getElementById('loginError');
      const resendLink = document.getElementById('resendLink');

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;

        if (supabaseClient) {
          try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) {
              loginError.style.display = 'block';
              loginError.textContent = 'Supabase login failed: ' + error.message;
              return;
            }

            // On success, Supabase client manages session in browser; optionally store email for compatibility
            localStorage.setItem('currentUser', email);
            window.location.href = 'Student_Dashboard.html';
            return;
          } catch (err) {
            console.error('Supabase signIn error', err);
            loginError.style.display = 'block';
            loginError.textContent = 'Unexpected error during login. See console.';
            return;
          }
        }

        // Fallback: localStorage-based demo
        const usersJSON = localStorage.getItem('users');
        const users = usersJSON ? JSON.parse(usersJSON) : {};

        if (!users[email] || users[email].password !== password) {
          loginError.style.display = 'block';
          loginError.textContent = 'Invalid email or password. If you don\'t have an account, please create one.';
          return;
        }

        localStorage.setItem('currentUser', email);
        window.location.href = 'Student_Dashboard.html';
      });

      // Resend confirmation email when user clicks the link
      resendLink.addEventListener('click', async (e) => {
        e.preventDefault();
        loginError.style.display = 'none';
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        if (!email) {
          loginError.style.display = 'block';
          loginError.textContent = 'Enter your email above, then click Resend.';
          return;
        }
        if (!supabaseClient) {
          loginError.style.display = 'block';
          loginError.textContent = 'Resend unavailable: Supabase not configured.';
          return;
        }
        try {
          const { error: resendError } = await supabaseClient.auth.resend({ type: 'signup', email });
          if (resendError) {
            loginError.style.display = 'block';
            loginError.textContent = 'Could not resend confirmation: ' + resendError.message;
            return;
          }
          loginError.style.display = 'block';
          loginError.style.color = '#0c7';
          loginError.textContent = 'Confirmation email sent. Please check your inbox.';
          setTimeout(() => {
            loginError.style.color = '#b00020';
            loginError.style.display = 'none';
          }, 5000);
        } catch (resErr) {
          console.error('Resend error', resErr);
          loginError.style.display = 'block';
          loginError.textContent = 'Unexpected error while resending.';
        }
      });
    </script>

  <footer>
    <img src="">
  </footer>

  <!-- JavaScript for sidebar toggle -->
  <script>
    const menuIcon = document.getElementById('menuIcon');
    const sidebar = document.getElementById('sidebar');
    const closeBtn = document.getElementById('closeBtn');
    const overlay = document.getElementById('overlay');

    menuIcon.addEventListener('click', () => {
      sidebar.classList.add('open');
      overlay.classList.add('show');
    });

    closeBtn.addEventListener('click', () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    });
  </script>


</body>
</html>
