<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Track Appointments ‚Ä¢ CJC School Frontline Services</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
	<div class="dashboard-layout">
		<aside class="sidebar">
			<img src="img/cjclogo.png" alt="CJC Logo" class="logo">
			<nav>
				<a href="proto2.html">Book Appointment</a>
				<a href="client_dashboard.html" class="active">Track Appointments</a>
				<a href="profile.html">My Profile</a>
			</nav>
			<button id="logoutBtn" class="logout-btn" style="margin-top:32px;">Sign Out</button>
		</aside>

		<main class="dashboard-main">
			<header class="dashboard-header">
				<h1>TRACK APPOINTMENTS</h1>
				<div class="welcome-block">
					<img id="headerProfilePicture" src="" alt="Profile" class="header-profile-picture" style="display:none;">
					<div id="welcomeText">Welcome back</div>
				</div>
			</header>

			<section class="appointments-wrapper" id="appointmentsSection">
				<div class="content-panel">
					<div class="filter-panel">
						<label for="statusFilter" style="font-weight:600;">Filter by status:</label>
						<select id="statusFilter">
							<option value="all">All</option>
							<option value="pending">Pending</option>
							<option value="approved">Approved</option>
							<option value="declined">Declined</option>
							<option value="completed">Completed</option>
						</select>
					</div>

					<div id="appointmentsList" class="appointment-cards">
						<div class="loading-state">Loading appointments...</div>
					</div>

					<button class="cta-button" id="bookBtn">Book New Appointment</button>
				</div>
			</section>
		</main>
	</div>

	<!-- Chat Modal -->
	<div id="chatModal" class="message-overlay">
		<div class="message-panel">
			<div class="message-header">
				<div>
					<p id="chatModalTitle">Message</p>
					<h2 id="chatModalName">Staff</h2>
				</div>
				<button class="message-close" id="closeChatModal">&times;</button>
			</div>
			<div class="message-body" id="chatModalMessages">
				<div class="message-empty">Loading messages...</div>
			</div>
			<div class="message-form">
				<textarea id="chatModalInput" placeholder="Type your message..." rows="3"></textarea>
				<div class="message-actions">
					<span class="message-hint">Press Enter to send, Shift+Enter for new line</span>
					<button class="message-send" id="chatModalSendBtn">Send</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const welcomeText = document.getElementById('welcomeText');
		const logoutBtn = document.getElementById('logoutBtn');
		const statusFilter = document.getElementById('statusFilter');
		const appointmentsList = document.getElementById('appointmentsList');
		let allAppointments = [];

		document.getElementById('bookBtn').addEventListener('click', () => {
			window.location.href = 'proto2.html';
		});

		logoutBtn.addEventListener('click', () => {
			fetch('logout.php', { method: 'POST' }).finally(() => {
				window.location.href = 'login.html';
			});
		});

		function loadProfile() {
			fetch('profile_info.php')
				.then(res => res.json())
				.then(data => {
					if (data.success && data.first_name) {
						welcomeText.textContent = `Welcome, ${data.first_name}`;
						
						// Load profile picture if available
						const profilePicture = document.getElementById('headerProfilePicture');
						if (data.profile_picture && data.profile_picture.trim() !== '') {
							profilePicture.src = data.profile_picture;
							profilePicture.style.display = 'block';
						} else {
							profilePicture.style.display = 'none';
						}
					}
				})
				.catch(() => {
					welcomeText.textContent = 'Welcome back';
				});
		}

		function fetchAppointments() {
			appointmentsList.innerHTML = '<div class="loading-state">Loading appointments...</div>';
			fetch('get_client_dashboard.php')
				.then(res => {
					if (!res.ok) throw new Error('Network response was not ok');
					return res.json();
				})
				.then(data => {
					if (data.error) throw new Error(data.error);
					if (!Array.isArray(data)) throw new Error('Invalid data format');
					allAppointments = data.sort((a, b) => {
						const dateCompare = String(b.appointment_date).localeCompare(String(a.appointment_date));
						return dateCompare !== 0 ? dateCompare : String(a.appointment_time).localeCompare(String(b.appointment_time));
					});
					renderAppointments();
				})
				.catch(error => {
					appointmentsList.innerHTML = `<div class="empty-state">Error loading appointments: ${error.message}</div>`;
				});
		}

		function normalizeStatus(status) {
			const value = (status || 'pending').toString().toLowerCase();
			if (value === 'accepted') return 'approved';
			return value;
		}

		function renderAppointments() {
			const filter = statusFilter.value;
			const filtered = filter === 'all'
				? allAppointments
				: allAppointments.filter(apt => normalizeStatus(apt.status) === filter);

			if (!filtered.length) {
				appointmentsList.innerHTML = `
					<div class="empty-state">
						<h2>No appointments found</h2>
						<p>${filter === 'all' ? 'You have not booked any appointments yet.' : 'No appointments with this status.'}</p>
					</div>
				`;
				return;
			}

			appointmentsList.innerHTML = filtered.map(appointment => {
				const status = normalizeStatus(appointment.status);
				const statusText = status.charAt(0).toUpperCase() + status.slice(1);
				const hasFeedback = appointment.has_feedback && appointment.rating;
				const feedbackStars = hasFeedback ? '‚≠ê'.repeat(appointment.rating) + '‚òÜ'.repeat(5 - appointment.rating) : '';
				
				return `
					<article class="appointment-card">
						<div class="card-row">
							<div class="office-label">${appointment.office || 'N/A'}</div>
							<span class="status-pill status-${status}">${statusText}</span>
						</div>
						<div class="card-grid">
							<div class="card-detail">
								<span>Concern</span>
								<span>${appointment.concern || '‚Äî'}</span>
							</div>
							<div class="card-detail">
								<span>Date Requested</span>
								<span>${formatDate(appointment.appointment_date)}</span>
							</div>
							<div class="card-detail">
								<span>Time</span>
								<span>${appointment.appointment_time || '‚Äî'}</span>
							</div>
							<div class="card-detail">
								<span>Email</span>
								<span>${appointment.email || '‚Äî'}</span>
							</div>
						</div>
						${hasFeedback ? `
							<div class="feedback-display" style="margin-top:16px;padding:16px;background:#f9fafb;border-radius:12px;border-left:4px solid var(--primary);">
								<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
									<strong style="color:var(--primary);font-size:0.9rem;">Your Feedback</strong>
									<span style="font-size:1.2rem;letter-spacing:2px;">${feedbackStars}</span>
								</div>
								<p style="color:#6b7280;font-size:0.9rem;margin:0;line-height:1.5;">${appointment.feedback_comment || '‚Äî'}</p>
							</div>
						` : ''}
						<div class="card-actions">
							${appointment.appointment_id
								? `<button class="btn-message message-btn" data-appointment-id="${appointment.appointment_id}" data-office="${(appointment.office || '').replace(/"/g, '&quot;')}" title="Message Staff" onclick="openChatModalFromButton(this)">üí¨ Message</button>`
								: ''
							}
							${status === 'completed' && appointment.appointment_id
								? `<button class="btn-feedback feedback-btn" data-id="${appointment.appointment_id}">${hasFeedback ? 'Edit Feedback' : 'Give Feedback'}</button>`
								: ''
							}
						</div>
					</article>
				`;
			}).join('');
		}

		function formatDate(value) {
			if (!value) return '‚Äî';
			const date = new Date(value);
			return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
		}

		statusFilter.addEventListener('change', renderAppointments);

		appointmentsList.addEventListener('click', (event) => {
			// Handle feedback button clicks
			if (event.target.classList.contains('feedback-btn')) {
				const id = event.target.getAttribute('data-id');
				if (id && id !== 'null' && id !== 'undefined' && !isNaN(id)) {
					window.location.href = `submit_feedback.php?appointment_id=${encodeURIComponent(id)}`;
				} else {
					alert('Invalid appointment ID. Please try again.');
					console.error('Invalid appointment_id:', id);
				}
				return;
			}
			
			// Handle message button clicks - check both the button and its parent
			const messageBtn = event.target.closest('.message-btn') || 
			                  (event.target.classList.contains('message-btn') ? event.target : null);
			if (messageBtn) {
				const appointmentId = messageBtn.getAttribute('data-appointment-id');
				const officeName = messageBtn.getAttribute('data-office');
				if (appointmentId) {
					openChatModal(appointmentId, officeName);
				} else {
					console.error('Missing appointment ID on message button');
				}
				return;
			}
		});

		// Chat Modal functionality
		const chatModal = document.getElementById('chatModal');
		const closeChatModal = document.getElementById('closeChatModal');
		const chatModalMessages = document.getElementById('chatModalMessages');
		const chatModalInput = document.getElementById('chatModalInput');
		const chatModalSendBtn = document.getElementById('chatModalSendBtn');
		const chatModalName = document.getElementById('chatModalName');
		const chatModalTitle = document.getElementById('chatModalTitle');

		let currentChatStaffId = null;
		let currentChatAppointmentId = null;
		let chatPollInterval = null;

		closeChatModal.addEventListener('click', () => {
			chatModal.classList.remove('active');
			if (chatPollInterval) {
				clearInterval(chatPollInterval);
				chatPollInterval = null;
			}
		});

		chatModal.addEventListener('click', (e) => {
			if (e.target === chatModal) {
				chatModal.classList.remove('active');
				if (chatPollInterval) {
					clearInterval(chatPollInterval);
					chatPollInterval = null;
				}
			}
		});

		function openChatModal(appointmentId, officeName) {
			console.log('openChatModal called with:', appointmentId, officeName);
			if (!appointmentId) {
				console.error('No appointment ID provided');
				alert('Error: Missing appointment ID');
				return;
			}
			currentChatAppointmentId = appointmentId;
			chatModalTitle.textContent = 'Message Staff';
			chatModalName.textContent = officeName || 'Staff';
			chatModalMessages.innerHTML = '<div class="message-empty">Loading...</div>';
			chatModalInput.value = '';
			// Remove any inline display:none and add active class for CSS visibility
			chatModal.style.display = '';
			chatModal.classList.add('active');
			console.log('Modal opened - active class added');

			// Get staff ID for this appointment
			fetch(`get_appointment_staff.php?appointment_id=${appointmentId}`)
				.then(res => res.json())
				.then(data => {
					if (data.success) {
						currentChatStaffId = data.staff_id;
						chatModalName.textContent = data.staff_email || officeName || 'Staff';
						loadChatMessages();
						startChatPolling();
					} else {
						chatModalMessages.innerHTML = `<div class="message-empty" style="color:#dc2626;">${data.error || 'Error loading staff information'}</div>`;
					}
				})
				.catch(err => {
					console.error('Error fetching staff:', err);
					chatModalMessages.innerHTML = '<div class="message-empty" style="color:#dc2626;">Error loading staff information</div>';
				});
		}

		// Helper function for onclick handler - must be defined after openChatModal
		window.openChatModalFromButton = function(button) {
			console.log('openChatModalFromButton called');
			const appointmentId = button.getAttribute('data-appointment-id');
			const officeName = button.getAttribute('data-office');
			console.log('Button data:', { appointmentId, officeName });
			if (appointmentId) {
				openChatModal(appointmentId, officeName);
			} else {
				console.error('Missing appointment ID');
				alert('Error: Could not find appointment ID');
			}
		};

		function loadChatMessages() {
			if (!currentChatStaffId) {
				console.log('No staff ID, skipping loadChatMessages');
				return;
			}
			
			console.log('Loading messages for staff ID:', currentChatStaffId);
			fetch(`get_messages.php?other_type=staff&other_id=${currentChatStaffId}`)
				.then(res => {
					console.log('Response status:', res.status);
					if (!res.ok) {
						return res.text().then(text => {
							console.error('Error response:', text);
							throw new Error(`HTTP ${res.status}: ${text}`);
						});
					}
					return res.json();
				})
				.then(data => {
					console.log('Messages data:', data);
					if (data.success && data.messages) {
						if (data.messages.length === 0) {
							chatModalMessages.innerHTML = '<div class="message-empty">No messages yet. Start the conversation!</div>';
							return;
						}
						chatModalMessages.innerHTML = data.messages.map(msg => {
							const isUser = msg.sender_type === 'user';
							const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
							return `
								<div class="message-bubble ${isUser ? 'user-message' : 'staff-message'}">
									<div class="message-meta">
										<span>${msg.sender_name || (isUser ? 'You' : 'Staff')}</span>
										<span>${time}</span>
									</div>
									<p>${msg.message}</p>
								</div>
							`;
						}).join('');
						chatModalMessages.scrollTop = chatModalMessages.scrollHeight;
					} else if (data.error) {
						console.error('Error from server:', data.error);
						chatModalMessages.innerHTML = `<div class="message-empty" style="color:#dc2626;">Error: ${data.error}</div>`;
					}
				})
				.catch(err => {
					console.error('Error loading messages:', err);
					chatModalMessages.innerHTML = '<div class="message-empty" style="color:#dc2626;">Error loading messages. Check console for details.</div>';
				});
		}

		chatModalSendBtn.addEventListener('click', sendChatMessage);
		chatModalInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendChatMessage();
			}
		});

		function sendChatMessage() {
			const message = chatModalInput.value.trim();
			if (!message || !currentChatStaffId) return;

			chatModalSendBtn.disabled = true;
			fetch('send_message.php', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					sender_type: 'user',
					recipient_type: 'staff',
					recipient_id: currentChatStaffId,
					message: message
				})
			})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					chatModalInput.value = '';
					loadChatMessages();
				} else {
					alert('Error sending message: ' + (data.error || 'Unknown error'));
				}
			})
			.catch(err => {
				alert('Error sending message');
			})
			.finally(() => {
				chatModalSendBtn.disabled = false;
			});
		}

		function startChatPolling() {
			if (chatPollInterval) clearInterval(chatPollInterval);
			chatPollInterval = setInterval(() => {
				if (currentChatStaffId) {
					loadChatMessages();
				}
			}, 5000); // Reduced frequency: 5 seconds instead of 3
		}

		loadProfile();
		fetchAppointments();
	</script>
</body>
</html>